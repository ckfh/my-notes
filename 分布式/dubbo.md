# 随手记

## 尚硅谷Dubbo教程视频笔记

- 单一应用架构
    - 当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。**此时，用于简化增删改查工作量的数据访问框架(ORM)是关键**。
- 垂直应用架构
    - 当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，提升效率的方法之一是将应用拆成”互不相干“的几个应用，以提升效率。**此时，用于加速前端页面开发的Web框架(MVC)是关键**。
- 分布式服务架构
    - 当垂直应用越来越多，应用之间”交互不可避免“，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。**此时，用于提高业务复用及整合的分布式服务框架(RPC)是关键**。
- 流动计算架构
    - 当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于”访问压力“实时管理集群容量，提高集群利用率。**此时，用于提高机器利用率的资源调度和治理中心(SOA)是关键**。
    - 流动计算架构可以根据访问压力动态地调整服务所需的机器数量。

决定RPC框架性能的两个点：

1. 通信效率。
2. 序列化效率(比如动态二进制流>JSON>XML)。

Dubbo工作流程关键点：

- proxy层：代理层，无论是consumer，还是provider，dubbo都会生成代理，代理之间进行网络通信。
- protocol层：远程调用层，封装RPC调用。
- exchange层：信息交换曾，封装请求响应模式，同步转异步。

Dubbo特点：

- 面向接口代理的高性能RPC调用
- 智能负载均衡
- 服务自动注册与发现
- 高度可扩展能力
- 运行期流量调度
- 可视化的服务治理与运维

DUBBO是RPC框架，SPRING-CLOUD是微服务架构，基于DUBBO可以构建出一套完整的微服务架构，但需要程序员进行大量的开发。

consumer从注册中心拿到provider的地址和端口，自己和provider进行通信交换数据，**因此真正发起远程调用的是consumer自己**。

Dubbo协议通常指的是consumer和provider之间的通信协议，而二者和注册中心通信的协议是`registry://`。

属性加载顺序：-D > XML > properties。

启动时检查：在启动时检查消费者依赖的服务是否可用，不可用时会抛出异常，可通过配置来关闭检查。

`dubbo:consumer`标签可以统一配置消费者端的一些配置，这样就不需要在每个单独的标签里面进行设置。

调用服务超时时间：默认为1S。

配置覆盖关系：方法级优先，接口级次之，全局配置再次之。如果级别一样，则消费方优先，提供方次之。

重试次数：

- 远程服务调用重试次数，不包括第一次调用，如果有多个服务提供方，则重试会尝试切换到其它的服务提供方。
- 对于满足幂等的请求，可以设置重试次数，不满足幂等的请求，则不允许设置重试次数。
- 幂等就是一个请求执行多次和执行一次的效果是一样的，非幂等则相反。

多版本：在Dubbo中为同一个服务配置多个版本，当一个接口实现，出现”不兼容“(即同时存在两个版本的服务实例)升级时，可以用版本号过渡，版本号不同的服务相互间不引用。

本地存根：

- 在Dubbo中利用本地存根在客户端执行部分逻辑。
- 远程服务后，客户端通常只剩下接口，而实现全在服务器端，但提供方有些时候想在客户端也执行部分逻辑，比如：做 ThreadLocal 缓存，提前验证参数，调用失败后伪造容错数据等等，此时就需要在 API 中带上 Stub，客户端生成 Proxy 实例，会把 Proxy 通过构造函数传给 Stub ，然后把 Stub 暴露给用户，Stub 可以决定要不要去调 Proxy。
- 本地存根的实现在开发时应该放在API层。

包扫描配置可以在主配置类中用`@EnableDubbo`注解来代替。

Dubbo和SpringBoot整合的三种方式：

1. 导入dubbo-starter，在application.properties配置属性，@Service暴露服务，@Reference引用服务
2. 保留dubbo.xml配置文件，使用springboot提供的@ImportResource注解导入配置文件
3. 使用注解API的方式

高可用：

- 即使注册中心挂掉，原本已经建立通信的client和server因为client会缓存server的地址和端口，因此仍可以继续进行通信。
- 就算没有注册中心，也能完成调用，因为注册中心本身就只是提供服务提供者的地址信息，因此完全可以绕过注册中心，直接使用Dubbo直连，在@Reference中配置URL地址信息。

负载均衡：

- Random LoadBalance
- RoundRobin LoadBalance
- LeastActive LoadBalance
- ConsistentHash LoadBalance

服务降级：

- 当服务器压力剧增的情况下，根据实际业务情况及流量，对一些服务和页面有策略的不处理或换种简单的方式处理，从而释放服务器资源以保证核心交易正常运作或高效运作。
- 可以通过服务降级功能临时屏蔽某个出错的非关键服务，并定义降级后的返回策略。
    1. 直接返回空
    2. 调用失败返回空
- 可直接在控制台的消费者端向注册中心进行动态配置。

集群容错：

- Failover Cluster
    - 失败自动切换，当出现失败，重试其它服务器。通常用于读操作，但重试会带来更长延迟。可通过 retries="2" 来设置重试次数(不含第一次)。
