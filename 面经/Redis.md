## 持久化方式

### RDB

- 在指定时间间隔内将内存中的数据写入到磁盘中，数据恢复就是将快照文件读回内存里；
- 一定时间内改变的 key 越多，则持久化的间隔越短，并且每次持久化的数据量就是触发持久化的 key 的数量，剩余的 key 会被放到下一次的持久化过程中；
- Redis 进程会 fork 出一个子进程来进行持久化操作，并且先将持久化的内容写入到一个临时文件，随后再合并到原始文件中，这样做的目的是为了防止如果一开始就写原始文件，写到一半进程崩溃，会导致文件损坏无法恢复；
- 如果要进行大规模的数据恢复，并且对数据恢复的完整性不敏感，那么 RDB 方式要比 AOF 方式更高效。
- RDB 的缺点是最后一次持久化的数据可能会丢失，原因可以参考上述第二点，如果剩余 key 等待持久化时进程崩溃，那么这部分内存数据也就丢失了。

### AOF

- 以日志的形式记录每一个更新操作，只允许追加写日志文件，数据恢复就是将所有的更新操作从头执行一遍；
- 如果 AOF 和 RDB 文件同时存在，则默认使用 AOF 文件进行数据恢复，因为 AOF 不会存在数据丢失情况；
- 如果遇到 AOF 文件损坏情况，可以使用 Redis 自带的工具进行修复，修复过程就是将内容当中不符合 Redis 协议的语句给删除；
- 可以选择始终同步/每秒同步/同步时机由系统决定等三种同步方式；
- 日志文件由于采用追加写的形式，当文件大小过大时，可采用重写压缩机制，对内容进行压缩，仅保留可以恢复数据的最小指令集，该机制流程与 RDB 中 fork 子进程写临时文件的方式类似。

### 持久化建议

- 官方推荐两个都启用；
- 如果对数据完整性不敏感，可以选择 RDB；
- 不推荐单独使用 AOF，因为存在潜藏 BUG；
- 如果只是纯内存缓存，可以都不启用。

## 缓存三问

### 缓存穿透

### 缓存击穿

### 缓存雪崩

