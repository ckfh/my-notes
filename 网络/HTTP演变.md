# HTTP演变

## HTTP2

### 【头部压缩】

综上，HTTP/2 头部的编码通过「静态表、动态表、Huffman 编码」共同完成的。

### 【二进制帧】

一条 HTTP 响应，划分成了两个帧来传输，并且采用二进制来编码。

每个二进制帧都分为帧头和帧数据两个部分，帧头包括帧长头、帧类型(数据帧和控制帧)、标志位(控制信息)、流标识符(标识该帧属于哪个流，接收方可以根据这个信息从乱序的帧里找到相同的流标识符的帧，从而有序组装信息)，帧数据则通过HPACK算法存储压缩过的HTTP头部或者包体。

### 【并发传输】

通过 Stream 这个设计，多个 Stream 复用一条 TCP 连接，达到并发的效果，解决了 HTTP/1.1 队头阻塞的问题，提高了 HTTP 传输的吞吐量。

1 个 TCP 连接包含一个或者多个 Stream，Stream 是 HTTP/2 并发的关键技术；

Stream 里可以包含 1 个或多个 Message，Message 对应 HTTP/1 中的请求或响应，由 HTTP 头部和包体构成；

Message 里包含一条或者多个 Frame，Frame 是 HTTP/2 最小单位，以二进制压缩格式存放 HTTP/1 中的内容（头部和包体）；

在 HTTP/2 连接上，不同 Stream 的帧是可以乱序发送的（因此可以并发不同的 Stream ），因为每个帧的头部会携带 Stream ID 信息，所以接收端可以通过 Stream ID 有序组装成 HTTP 消息，而同一 Stream 内部的帧必须是严格有序的。

客户端和服务器双方都可以建立 Stream， Stream ID 也是有区别的，客户端建立的 Stream 必须是奇数号，而服务器建立的 Stream 必须是偶数号。

同一个连接中的 Stream ID 是不能复用的，只能顺序递增，所以当 Stream ID 耗尽时，需要发一个控制帧 GOAWAY，用来关闭 TCP 连接。

HTTP/2 还可以对每个 Stream 设置不同优先级，帧头中的「标志位」可以设置优先级，比如客户端访问 HTML/CSS 和图片资源时，希望服务器先传递 HTML/CSS，再传图片，那么就可以通过设置 Stream 的优先级来实现，以此提高用户体验。

### 【服务器主动推送资源】

在 HTTP/2 中，客户端在访问 HTML 时，服务器可以直接主动推送 CSS 文件，减少了消息传递的次数。

客户端发起的请求，必须使用的是奇数号 Stream，服务器主动的推送，使用的是偶数号 Stream。服务器在推送资源时，会通过 PUSH_PROMISE 帧传输 HTTP 头部，并通过帧中的 Promised Stream ID 字段告知客户端，接下来会在哪个偶数号 Stream 中发送包体。

HTTP1.1的队头阻塞问题：同一连接只能在完成一个 HTTP 事务（请求和响应）后，才能处理下一个事务；(应用层)

HTTP2的队头阻塞问题：HTTP/2 是基于 TCP 协议来传输数据的，TCP 是字节流协议，TCP 层必须保证收到的字节数据是完整且连续的，这样内核才会将缓冲区里的数据返回给 HTTP 应用，那么当「前 1 个字节数据」没有到达时，后收到的字节数据只能存放在内核缓冲区里，只有等到这 1 个字节数据到达时，HTTP/2 应用层才能从内核中拿到数据，这就是 HTTP/2 队头阻塞问题。(传输层)

## HTTP3

### 【QUIC】

HTTP/3 不仅仅只是简单将传输协议替换成了 UDP，还基于 UDP 协议在「应用层」实现了 QUIC 协议，它具有类似 TCP 的连接管理、拥塞窗口、流量控制的网络特性，相当于将不可靠传输的 UDP 协议变成“可靠”的了，所以不用担心数据包丢失的问题。

### 【无队头阻塞】

由于 QUIC 使用的传输协议是 UDP，UDP 不关心数据包的顺序，如果数据包丢失，UDP 也不关心。不过，QUIC 协议会保证数据包的可靠性，每个数据包都有一个序号唯一标识。

如果 QUIC 连接中的某个流中的一个数据包丢失了，只会阻塞该流，其他流不会受影响。这与 HTTP/2 不同，HTTP/2 只要某个流中的数据包丢失了，其他流也会因此受影响。

所以，QUIC 连接上的多个 Stream 之间并没有依赖，都是独立的，某个流发生丢包了，只会影响该流，其他流不受影响，消除了 HTTP/2 的队头阻塞问题。

### 【更快的连接建立】

对于 HTTP/1 和 HTTP/2 协议，TCP 和 TLS 是分层的，分别属于内核实现的传输层、openssl 库实现的表示层，因此它们难以合并在一起，需要分批次来握手，先 TCP 握手，再 TLS 握手。

HTTP/3 在传输数据前虽然需要 QUIC 协议握手，这个握手过程只需要 1 RTT，握手的目的是为确认双方的「连接 ID」，连接迁移就是基于连接 ID 实现的。

但是 HTTP/3 的 QUIC 协议并不是与 TLS 分层，而是QUIC 内部包含了 TLS，它在自己的帧会携带 TLS 里的“记录”，再加上 QUIC 使用的是 TLS1.3，因此仅需 1 个 RTT 就可以「同时」完成建立连接与密钥协商，甚至在第二次连接的时候，应用数据包可以和 QUIC 握手信息（连接信息 + TLS 信息）一起发送，达到 0-RTT 的效果。

### 【连接迁移】

基于 TCP 传输协议的 HTTP 协议，由于是通过四元组（源 IP、源端口、目的 IP、目的端口）确定一条 TCP 连接。

那么当移动设备的网络从 4G 切换到 WIFI 时，意味着 IP 地址变化了，就必须要断开连接，然后重新建立连接，而建立连接的过程包含 TCP 三次握手和 TLS 四次握手的时延，以及 TCP 慢启动的减速过程，给用户的感觉就是网络突然卡顿了一下，因此连接的迁移成本是很高的。

而 QUIC 协议没有用四元组的方式来“绑定”连接，而是通过连接 ID来标记通信的两个端点，客户端和服务器可以各自选择一组 ID 来标记自己。

因此，即使移动设备的网络变化后，导致 IP 地址变化了，只要仍保有上下文信息（比如连接 ID、TLS 密钥等），就可以“无缝”地复用原连接，消除重连的成本，没有丝毫卡顿感，达到了连接迁移的功能。

### 【HTTP3】

HTTP2结构：应用层HTTP2，传输层TLS1.2+以及TCP

HTTP3结构：应用层HTTP3，传输层QUIC(包含TLS1.3)以及UDP

HTTP/3 同 HTTP/2 一样采用二进制帧的结构，不同的地方在于 HTTP/2 的二进制帧里需要定义 Stream(流标识符)，而 HTTP/3 自身不需要再定义 Stream，直接使用 QUIC 里的 Stream，于是 HTTP/3 的帧的结构也变简单了。

HTTP/3 的 QPACK 通过两个特殊的单向流来同步双方的动态表，解决了 HTTP/2 的 HPACK 队头阻塞问题。

## HTTP的优化历程

### HTTP1.1

长连接：在1.0时期，应用层每发送HTTP请求和接收HTTP响应，都需要建立一次TCP连接和断开连接。

而长连接的意思就是建立一次TCP连接后，可以在期间发送多次HTTP请求和接收响应。

管道网络传输：发送方可以一次性发送多个请求给接收方，但是接收方依旧需要按照“顺序”发送响应给接收方，如果之前的响应处理特别慢，后续已经完成的响应就无法进行发送。

队头阻塞：指的就是发生在服务端因为需要按照“顺序”进行响应，如果前面响应特别慢，这就会造成队头阻塞。

### 优化HTTP1.1

1. 避免发送HTTP请求
    1. 缓存技术
2. 减少HTTP请求次数
    1. 减少重定向请求次数
    2. 合并请求
    3. 延迟发送请求
3. 减少HTTP响应的数据大小
    1. 无损压缩
    2.有损压缩

### HTTP2

1.1除了队头阻塞问题，还有以下几个问题：

- 延迟难以下降；
- 并发连接有限；
- HTTP头部巨大且重复；
- 不支持服务器推送消息。

因此HTTP2实现了头部压缩、二进制帧、服务器支持推送、并发传输等功能。

其中并发传输可以理解为，在1个TCP连接上可以建立多条stream，而在每条stream里面就是包含多个HTTP请求和响应。

**相当于把stream当成了建立在一个大TCP上的多个小TCP**。

HTTP2的队头阻塞问题是因为多个stream建立在同一个TCP上，因为TCP保证必须是无丢包行为，一旦某个stream发生了丢包，则其它所有的stream都必须停下来等待包的重传。

### HTTPS优化

HTTPS的性能损耗在TLS协议握手和握手后的对称加密报文传输。

硬件优化

1. 选择支持AES-NI特性的CPU，因为HTTPS协议是计算密集型的。

软件优化

1. 升级内核
2. 升级OPENSSL

会话复用

既然TLS握手是为了协商出会话密钥，那就把会话密钥缓存起来，下次再建立连接的时候，直接复用就好了，就不需要协商过程了。

Session ID

用session ID对会话密钥进行映射，下次连接就直接用该会话密钥恢复会话状态。缺点是服务器内存压力大，如果有负载均衡，客户端不一定命中上次的服务端。

Session Ticket

服务端不缓存，客户端缓存，类似cookie，客户端将ticket发给服务端之后，解密得到会话密钥。

Pre-shared key

TLS1.3直接把ticket和HTTP请求放在一起，即发送了请求也完成了会话恢复，0RTT恢复会话。

协议优化

1. 选用ECDHE密钥交换算法替代RSA算法，RSA慢且安全性不高，ECDHE将握手的消息往返从2RTT减少到1RTT，具备前向安全性。
2. 选用TLS1.3，完成TLS握手只需要1RTT，只支持ECDHE密钥交换算法。

证书优化

1. 证书传输优化，选用ECDSA证书，该证书的ECC密钥长度比RSA短得多。
2. 证书验证优化，CRL、OCSP、OCSP STAPLING
