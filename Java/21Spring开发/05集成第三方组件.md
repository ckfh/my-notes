# 集成第三方组件

## 集成JavaMail

在Spring中，发送邮件最终也是需要JavaMail，Spring只对JavaMail做了一点简单的封装，目的是简化代码。

我们希望用户在注册成功后能收到注册邮件，为此，我们先定义一个JavaMailSender的Bean；

下一步是封装一个MailService，并定义sendRegistrationMail()方法；

```Java
@Component
public class MailService {
    @Value("${smtp.from}")
    String from;
    @Autowired
    JavaMailSender mailSender;

    public void sendRegistrationMail(User user) {
        try {
            // MimeMessage是JavaMail的邮件对象：
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            // MimeMessageHelper是Spring提供的用于简化设置MimeMessage的类:
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, "utf-8");
            helper.setFrom(from);
            helper.setTo(user.getEmail());
            helper.setSubject("Welcome to Java course!");
            String html = String.format("<p>Hi, %s,</p><p>Welcome to Java course!</p><p>Sent at %s</p>", user.getName(), LocalDateTime.now());
            // 设置HTML邮件就可以直接调用setText(String text, boolean html)方法，而不必再调用比较繁琐的JavaMail接口方法：
            helper.setText(html, true);
            // 调用JavaMailSender.send()方法把邮件发送出去：
            mailSender.send(mimeMessage);
        } catch (MessagingException e) {
            throw new RuntimeException(e);
        }
    }
}
```

在MVC的某个Controller方法中，当用户注册成功后，我们就启动一个新线程来异步发送邮件：

```Java
@PostMapping("/register")
public ModelAndView doRegister(@RequestParam("email") String email, @RequestParam("password") String password, @RequestParam("name") String name) {
    try {
        User user = userService.register(email, password, name);
        logger.info("user registered: {}", user.getEmail());
        // send registration mail:
        new Thread(() -> {
            mailService.sendRegistrationMail(user);
        }).start();
    } catch (RuntimeException e) {
        return new ModelAndView("register.html", Map.of("email", email, "error", "Register failed"));
    }
    return new ModelAndView("redirect:/signin");
}
```

**因为发送邮件是一种耗时的任务，从几秒到几分钟不等，因此，异步发送是保证页面能快速显示的必要措施。这里我们直接启动了一个新的线程**。

Spring可以集成JavaMail，通过简单的封装，能简化邮件发送代码。**其核心是定义一个JavaMailSender的Bean，然后调用其send()方法**。

## 集成JMS

JMS即Java Message Service，是JavaEE的消息服务接口。

所谓消息服务，就是两个进程之间，通过消息服务器传递消息。

使用消息服务，而不是直接调用对方的API，它的好处是：

- 双方各自无需知晓对方的存在，消息可以异步处理，因为消息服务器会在Consumer离线的时候自动缓存消息；
- 如果Producer发送的消息频率高于Consumer的处理能力，消息可以积压在消息服务器，不至于压垮Consumer；
- 通过一个消息服务器，可以连接多个Producer和多个Consumer。

因为消息服务在各类应用程序中非常有用，所以JavaEE专门定义了JMS规范。**注意到JMS是一组接口定义，如果我们要使用JMS，还需要选择一个具体的JMS产品**。

## 集成Scheduler

## 集成JMX

JMX是Java Management Extensions，它是一个Java平台的管理和监控接口。为什么要搞JMX呢？因为在所有的应用程序中，对运行中的程序进行监控都是非常重要的，Java应用程序也不例外。我们肯定希望知道Java应用程序当前的状态，例如，占用了多少内存，分配了多少内存，当前有多少活动线程，有多少休眠线程等等。如何获取这些信息呢？

为了标准化管理和监控，Java平台使用JMX作为管理和监控的标准接口，任何程序，只要按JMX规范访问这个接口，就可以获取所有管理与监控信息。

实际上，常用的运维监控如Zabbix、Nagios等工具对JVM本身的监控都是通过JMX获取的信息。
