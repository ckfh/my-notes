# 线程管理

## 互斥

临界区（critical section），它是访问共享资源的代码片段，一定不能给多线程同时执行。

我们希望这段代码是互斥（mutualexclusion）的，也就说保证一个线程在临界区执行时，其他线程应该被阻止进入临界区，说白了，就是这段代码执行过程中，最多只能出现一个线程。

锁和信号量都可以实现互斥操作。

锁就是进去加锁，出来解锁。

信号量就是进去P操作，出来V操作，需要提前准备一个信号量用来表示资源的数量，大于0。

## 同步

所谓同步，就是并发进程/线程在一些关键点上可能需要互相等待与互通消息，这种相互制约的等待与互通信息称为进程/线程同步。

信号量可以实现同步操作，在同步操作中，一般都是准备初值为0的信号量。

```text
s1 = 0 // 表示不需要吃饭
s2 = 0 // 表示饭还没做完
// 儿子
V(s1) // 叫妈妈做饭
P(s2) // 等待妈妈做完饭
// 妈妈
P(s1) // 询问需不需要做饭
V(s2) // 做完饭，通知儿子吃饭
```

## 生产者消费者

### 描述

- 生产者在生成数据后，放在一个缓冲区中；
- 消费者从缓冲区取出数据处理；
- 任何时刻，只能有一个生产者或消费者可以访问缓冲区；

### 分析

- 任何时刻只能有一个线程操作缓冲区，说明操作缓冲区是临界代码，需要互斥；
- 缓冲区空时，消费者必须等待生产者生成数据；缓冲区满时，生产者必须等待消费者取出数据。说明生产者和消费者需要同步。

需要三个信号量：

- 互斥信号量 mutex：用于互斥访问缓冲区，初始化值为 1；
- 资源信号量 fullBuffers：用于消费者询问缓冲区是否有数据，有数据则读取数据，初始化值为 0（表明缓冲区一开始为空）；
- 资源信号量 emptyBuffers：用于生产者询问缓冲区是否有空位，有空位则生成数据，初始化值为 n （缓冲区大小）；
