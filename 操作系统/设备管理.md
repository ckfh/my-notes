# 设备管理

## 设备控制器

为了屏蔽设备之间的差异，每个设备都有⼀个叫设备控制器（Device Control） 的组件，⽐如硬盘有硬盘控制器、显示器有视频控制器等。

## I/O控制方式

使⽤ DMA（Direct Memory Access） 功能，它可以使得设备在 CPU 不参与的情况下，能够⾃⾏完成把设备 I/O 数据放⼊到内存。

## 设备驱动程序

虽然设备控制器屏蔽了设备的众多细节，但每种设备的控制器的寄存器、缓冲区等使⽤模式都是不同的，所以为了屏蔽「设备控制器」的差异，引⼊了设备驱动程序。

## 通用块层

## 存储系统I/O软件分层

## 键盘敲入字母时，期间发生了什么？

CPU的硬件架构图如下：

- CPU和I/O桥接器之间通过系统总线连接在一起。
- 内存和I/O桥接器之间通过内存总线连接在一起。
- I/O桥接器可以传输数据到I/O总线。
- 设备借助控制器传输数据到I/O总线。

当⽤户输⼊了键盘字符，**键盘控制器**就会产⽣扫描码数据，并将其缓冲在键盘控制器的寄存器中，紧接着键盘控制器通过总线给 CPU 发送**中断请求**。

CPU 收到中断请求后，操作系统会**保存被中断进程的 CPU 上下⽂**，然后调⽤键盘的**中断处理程序**。

键盘的中断处理程序是在**键盘驱动程序**初始化时注册的，那键盘**中断处理函数**的功能就是从键盘控制器的寄存器的缓冲区读取扫描码，再根据扫描码找到⽤户在键盘输⼊的字符，如果输⼊的字符是显示字符，那就会把扫描码翻译成对应显示字符的 ASCII 码，⽐如⽤户在键盘输⼊的是字⺟ A，是显示字符，于是就会把扫描码翻译成 A 字符的 ASCII 码。

得到了显示字符的 ASCII 码后，就会把 ASCII 码放到「读缓冲区队列」，接下来就是要把显示字符显示屏幕了，显示设备的驱动程序会定时从「读缓冲区队列」读取数据放到「写缓冲区队列」，最后把「写缓冲区队列」的数据⼀个⼀个写⼊到显示设备的控制器的寄存器中的数据缓冲区，最后将这些数据显示在屏幕⾥。

显示出结果后，**恢复被中断进程的上下⽂**。
